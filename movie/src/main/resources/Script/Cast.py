'''
[
{
    'cast_id': 14, 
    'character': 'Woody (voice)', 
    'credit_id': '52fe4284c3a36847f8024f95', 
    'gender': 2, 
    'id': 31, 
    'name': 'Tom Hanks', 
    'order': 0, 
    'profile_path': '/pQFoyx7rp09CJTAb932F2g8Nlho.jpg'
}, 
{'cast_id': 15, 'character': 'Buzz Lightyear (voice)', 'credit_id': '52fe4284c3a36847f8024f99', 'gender': 2, 'id': 12898, 'name': 'Tim Allen', 'order': 1, 'profile_path': '/uX2xVf6pMmPepxnvFWyBtjexzgY.jpg'}, 
{'cast_id': 16, 'character': 'Mr. Potato Head (voice)', 'credit_id': '52fe4284c3a36847f8024f9d', 'gender': 2, 'id': 7167, 'name': 'Don Rickles', 'order': 2, 'profile_path': '/h5BcaDMPRVLHLDzbQavec4xfSdt.jpg'}, 
{'cast_id': 17, 'character': 'Slinky Dog (voice)', 'credit_id': '52fe4284c3a36847f8024fa1', 'gender': 2, 'id': 12899, 'name': 'Jim Varney', 'order': 3, 'profile_path': '/eIo2jVVXYgjDtaHoF19Ll9vtW7h.jpg'}, 
{'cast_id': 18, 'character': 'Rex (voice)', 'credit_id': '52fe4284c3a36847f8024fa5', 'gender': 2, 'id': 12900, 'name': 'Wallace Shawn', 'order': 4, 'profile_path': '/oGE6JqPP2xH4tNORKNqxbNPYi7u.jpg'}, 
{'cast_id': 19, 'character': 'Hamm (voice)', 'credit_id': '52fe4284c3a36847f8024fa9', 'gender': 2, 'id': 7907, 'name': 'John Ratzenberger', 'order': 5, 'profile_path': '/yGechiKWL6TJDfVE2KPSJYqdMsY.jpg'}, 
{'cast_id': 20, 'character': 'Bo Peep (voice)', 'credit_id': '52fe4284c3a36847f8024fad', 'gender': 1, 'id': 8873, 'name': 'Annie Potts', 'order': 6, 'profile_path': '/eryXT84RL41jHSJcMy4kS3u9y6w.jpg'}, 
{'cast_id': 26, 'character': 'Andy (voice)', 'credit_id': '52fe4284c3a36847f8024fc1', 'gender': 0, 'id': 1116442, 'name': 'John Morris', 'order': 7, 'profile_path': '/vYGyvK4LzeaUCoNSHtsuqJUY15M.jpg'}, 
{'cast_id': 22, 'character': 'Sid (voice)', 'credit_id': '52fe4284c3a36847f8024fb1', 'gender': 2, 'id': 12901, 'name': 'Erik von Detten', 'order': 8, 'profile_path': '/twnF1ZaJ1FUNUuo6xLXwcxjayBE.jpg'}, 
{'cast_id': 23, 'character': 'Mrs. Davis (voice)', 'credit_id': '52fe4284c3a36847f8024fb5', 'gender': 1, 'id': 12133, 'name': 'Laurie Metcalf', 'order': 9, 'profile_path': '/unMMIT60eoBM2sN2nyR7EZ2BvvD.jpg'}, 
{'cast_id': 24, 'character': 'Sergeant (voice)', 'credit_id': '52fe4284c3a36847f8024fb9', 'gender': 2, 'id': 8655, 'name': 'R. Lee Ermey', 'order': 10, 'profile_path': '/r8GBqFBjypLUP9VVqDqfZ7wYbSs.jpg'}, 
{'cast_id': 25, 'character': 'Hannah (voice)', 'credit_id': '52fe4284c3a36847f8024fbd', 'gender': 1, 'id': 12903, 'name': 'Sarah Freeman', 'order': 11, 'profile_path': None}, 
{'cast_id': 27, 'character': 'TV Announcer (voice)', 'credit_id': '52fe4284c3a36847f8024fc5', 'gender': 2, 'id': 37221, 'name': 'Penn Jillette', 'order': 12, 'profile_path': '/zmAaXUdx12NRsssgHbk1T31j2x9.jpg'}]

[{'cast_id': 2, 'character': 'Max Goldman', 'credit_id': '52fe466a9251416c75077a8d', 'gender': 2, 'id': 6837, 'name': 'Walter Matthau', 'order': 0, 'profile_path': '/xJVkvprOnzP5Zdh5y63y8HHniDZ.jpg'}, {'cast_id': 3, 'character': 'John Gustafson', 'credit_id': '52fe466a9251416c75077a91', 'gender': 2, 'id': 3151, 'name': 'Jack Lemmon', 'order': 1, 'profile_path': '/chZmNRYMtqkiDlatprGDH4BzGqG.jpg'}, {'cast_id': 4, 'character': 'Ariel Gustafson', 'credit_id': '52fe466a9251416c75077a95', 'gender': 1, 'id': 13567, 'name': 'Ann-Margret', 'order': 2, 'profile_path': '/jx5lTaJ5VXZHYB52gaOTAZ9STZk.jpg'}, {'cast_id': 5, 'character': 'Maria Sophia Coletta Ragetti', 'credit_id': '52fe466a9251416c75077a99', 'gender': 1, 'id': 16757, 'name': 'Sophia Loren', 'order': 3, 'profile_path': '/emKLhbji1c7BjcA2DdbWf0EP9zH.jpg'}, {'cast_id': 6, 'character': 'Melanie Gustafson', 'credit_id': '52fe466a9251416c75077a9d', 'gender': 1, 'id': 589, 'name': 'Daryl Hannah', 'order': 4, 'profile_path': '/4LLmp6AQdlj6ueGCRbVRSGvvFSt.jpg'}, {'cast_id': 9, 'character': 'Grandpa Gustafson', 'credit_id': '53e5fcc2c3a3684430000d65', 'gender': 2, 'id': 16523, 'name': 'Burgess Meredith', 'order': 5, 'profile_path': '/lm98oKloU33Q7QDIIMSyc4Pr2jA.jpg'}, {'cast_id': 10, 'character': 'Jacob Goldman', 'credit_id': '53e5fcd4c3a3684433000e1a', 'gender': 2, 'id': 7166, 'name': 'Kevin Pollak', 'order': 6, 'profile_path': '/kwu2T8CDnThZTzE88uiSgJ5eHXf.jpg'}]
'''
import pymysql
import pandas as pd
from pymysql import Error
import json

class Cast:
    def __init__(self, path):
        self.path = path
        self.connection = None

    def connect_to_db(self):
        try:
            connection = pymysql.connect(
                host='localhost',
                port=3306,
                database='PMRS',
                user='root',
                password='123456',
                # charset="utf8"
            )

            if connection:
                print("Connected to MySQL database")

        except Error as e:
            print("Error while connecting to MySQL", e)
        self.connection = connection
    
    def parse_casts(self, casts):
        cast_list = casts.replace('[','').replace(']','').split('{')
        res = []
        for i in range(1, len(cast_list)):
            # s = ('{' + cast_list[i]).replace("{'", "{\"").replace("':", "\":").replace(", '", ", \"")
            s = '{' + cast_list[i]
            if i == len(cast_list) - 1:
                a = eval(s)
            else:
                a = eval(s[:-2])
            # print(a["cast_id"])
            res.append(a)
        return res
    
    def insert_cast(self):
        self.connect_to_db()
        data = pd.read_csv(self.path, encoding="latin1")

        cursor = self.connection.cursor(cursor=pymysql.cursors.DictCursor)
        
        cnt = 0
        for row in data.itertuples():
            cast_list = row.cast
            casts = self.parse_casts(cast_list)
            for cast in casts:
                query = "INSERT IGNORE INTO MovieCast (`movieId`, `castId`, `castOrder`, `character`) VALUES (%s, %s, %s, %s)"
                values = (str(row.id), str(cast['id']), str(cast['order']), str(cast['character']))
                cursor.execute(query, values)
                cnt += 1
                # print(cnt)
                if cnt % 1000 == 0:
                    self.connection.commit()
                    print("commit " + str(cnt) + " records")

        self.connection.commit()
        print("commit " + str(cnt) +  "lines")    
        cursor.close()
        self.connection.close()

    def insert_castinfo(self):
        self.connect_to_db()
        data = pd.read_csv(self.path, encoding="latin1")

        cursor = self.connection.cursor(cursor=pymysql.cursors.DictCursor)
        
        cnt = 0
        for row in data.itertuples():
            cast_list = row.cast
            casts = self.parse_casts(cast_list)
            for cast in casts:
                query = "INSERT IGNORE INTO Cast (`castId`, `gender`, `castName`, `profilePath`) VALUES (%s, %s, %s, %s)"
                values = (str(cast['id']), str(cast['gender']),str(cast['name']), str(cast['profile_path']))

                cursor.execute(query, values)
                cnt += 1
                # print(cnt)
                if cnt % 1000 == 0:
                    self.connection.commit()
                    print("commit " + str(cnt) + " records")

        self.connection.commit()
        print("commit " + str(cnt) +  " lines")    
        cursor.close()
        self.connection.close()
    
    def update_movie_cast(self):
        self.connect_to_db()
        data = pd.read_csv(self.path, encoding="latin1")

        cursor = self.connection.cursor(cursor=pymysql.cursors.DictCursor)
        
        cnt = 0
        for row in data.itertuples():
            cast_list = row.cast
            casts = self.parse_casts(cast_list)
            for cast in casts:
                query = "UPDATE MovieCast SET `castName` = %s WHERE `movieId` = %s AND `castId` = %s"
                values = (str(cast['name']), str(row.id), str(cast['id']))
                cursor.execute(query, values)

                cnt += 1
                # print(cnt)
                if cnt % 1000 == 0:
                    self.connection.commit()
                    print("commit " + str(cnt) + " records")

        self.connection.commit()
        print("commit " + str(cnt) +  "lines")    
        cursor.close()
        self.connection.close()


if __name__ == '__main__':
    cast = Cast("/Users/jackwu/Desktop/HKU/Project/credits.csv")
    # casts = cast.parse_casts("[{'cast_id': 2, 'character': 'Max Goldman', 'credit_id': '52fe466a9251416c75077a8d', 'gender': 2, 'id': 6837, 'name': 'Walter Matthau', 'order': 0, 'profile_path': '/xJVkvprOnzP5Zdh5y63y8HHniDZ.jpg'}, {'cast_id': 3, 'character': 'John Gustafson', 'credit_id': '52fe466a9251416c75077a91', 'gender': 2, 'id': 3151, 'name': 'Jack Lemmon', 'order': 1, 'profile_path': '/chZmNRYMtqkiDlatprGDH4BzGqG.jpg'}, {'cast_id': 4, 'character': 'Ariel Gustafson', 'credit_id': '52fe466a9251416c75077a95', 'gender': 1, 'id': 13567, 'name': 'Ann-Margret', 'order': 2, 'profile_path': '/jx5lTaJ5VXZHYB52gaOTAZ9STZk.jpg'}, {'cast_id': 5, 'character': 'Maria Sophia Coletta Ragetti', 'credit_id': '52fe466a9251416c75077a99', 'gender': 1, 'id': 16757, 'name': 'Sophia Loren', 'order': 3, 'profile_path': '/emKLhbji1c7BjcA2DdbWf0EP9zH.jpg'}, {'cast_id': 6, 'character': 'Melanie Gustafson', 'credit_id': '52fe466a9251416c75077a9d', 'gender': 1, 'id': 589, 'name': 'Daryl Hannah', 'order': 4, 'profile_path': '/4LLmp6AQdlj6ueGCRbVRSGvvFSt.jpg'}, {'cast_id': 9, 'character': 'Grandpa Gustafson', 'credit_id': '53e5fcc2c3a3684430000d65', 'gender': 2, 'id': 16523, 'name': 'Burgess Meredith', 'order': 5, 'profile_path': '/lm98oKloU33Q7QDIIMSyc4Pr2jA.jpg'}, {'cast_id': 10, 'character': 'Jacob Goldman', 'credit_id': '53e5fcd4c3a3684433000e1a', 'gender': 2, 'id': 7166, 'name': 'Kevin Pollak', 'order': 6, 'profile_path': '/kwu2T8CDnThZTzE88uiSgJ5eHXf.jpg'}]")
    # cast.insert_castinfo()
    # cast.insert_cast()
    cast.update_movie_cast()